<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ACPS Sales Report</title>
    <style>
      :root {
        --bg: #070707;
        --border: #242426;
        --text: #e7e7e7;
        --muted: #a7a7a7;
        --accent: #c81c1c;
        --surface: rgba(18, 18, 20, 0.92);
        --radius: 16px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 20px;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Poppins", Arial, sans-serif;
        background:
          radial-gradient(1200px 700px at 20% -10%, rgba(200, 28, 28, 0.15), transparent 60%),
          linear-gradient(180deg, #050505 0%, #070707 100%);
        color: var(--text);
        min-height: 100vh;
      }
      .wrap { max-width: 1200px; margin: 0 auto; }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding: 16px 20px;
        background: linear-gradient(#121214eb, #0c0c0deb);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      .brand { display: flex; align-items: center; gap: 15px; }
      .brand img { height: 40px; width: auto; }
      .brand-text .title { font-weight: 900; font-size: 18px; letter-spacing: 0.5px; }
      .brand-text .subtitle { color: var(--muted); font-size: 12px; }
      .back-btn {
        color: var(--text);
        text-decoration: none;
        font-weight: 900;
        font-size: 12px;
        border: 1px solid var(--accent);
        padding: 8px 16px;
        border-radius: 12px;
        background: rgba(200, 28, 28, 0.1);
        transition: all 0.2s;
        white-space: nowrap;
      }
      .back-btn:hover { background: rgba(200, 28, 28, 0.2); transform: translateY(-1px); }

      .filters {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      input[type="date"], input[type="file"] {
        background: #111;
        border: 1px solid var(--border);
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        outline: none;
        font-family: inherit;
        font-size: 13px;
      }
      .btn {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 800;
        cursor: pointer;
        transition: opacity 0.2s;
        font-family: inherit;
        font-size: 12px;
        letter-spacing: 0.4px;
      }
      .btn:hover { opacity: 0.85; }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }
      .stat-val { font-size: 28px; font-weight: 900; color: #fff; margin: 5px 0; }
      .stat-label {
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 800;
      }

      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        margin-bottom: 30px;
      }
      .card-hd {
        padding: 20px;
        border-bottom: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.03);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .card-hd h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 900;
        color: var(--accent);
        text-transform: uppercase;
      }
      .card-hd .loc-total { font-size: 16px; font-weight: 800; color: #fff; }

      table { width: 100%; border-collapse: collapse; font-size: 13px; }
      th {
        text-align: right;
        padding: 12px 20px;
        color: var(--muted);
        font-weight: 900;
        border-bottom: 1px solid var(--border);
        text-transform: uppercase;
        font-size: 11px;
      }
      th:first-child { text-align: left; }
      td { padding: 12px 20px; border-bottom: 1px solid var(--border); text-align: right; }
      td:first-child { text-align: left; font-weight: 700; }
      tr:last-child td { border-bottom: none; }

      .col-square { color: #3b82f6; }
      .col-swiped { color: #10b981; }
      .col-manual { color: #f59e0b; }
      .col-total { font-weight: 900; color: #fff; }

      tfoot tr { background: rgba(255, 255, 255, 0.05); font-weight: 900; }

      .empty { padding: 40px; text-align: center; color: var(--muted); font-weight: 700; }

      .warn {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.04);
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        color: var(--muted);
        font-size: 12px;
      }
      .warn b { color: #fff; }

      .upload-card {
        display: none;
        border: 1px solid rgba(200, 28, 28, 0.45);
        background: rgba(200, 28, 28, 0.08);
      }
      .upload-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
      }
      .mini {
        padding: 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.18);
      }
      .mini .label { color: #fff; font-weight: 900; font-size: 12px; text-transform: uppercase; letter-spacing: 0.4px; }
      .mini .hint { margin-top: 6px; font-size: 12px; opacity: 0.8; }

      .mobile-summary { display: none; }

      @media (max-width: 768px) {
        body { padding: 10px; }
        .header { flex-direction: column; text-align: center; }
        .brand { flex-direction: column; }
        .filters { width: 100%; flex-direction: column; }
        .filters input, .filters button { width: 100%; }
        .upload-grid { grid-template-columns: 1fr; }

        /* Table to cards */
        table, thead, tbody, th, td, tr { display: block; }
        thead tr { position: absolute; top: -9999px; left: -9999px; }
        
        tr {
          border: 1px solid var(--border);
          margin: 0 0 10px;
          border-radius: 12px;
          background: rgba(255, 255, 255, 0.02);
          padding: 12px;
          cursor: pointer;
          transition: background 0.2s;
        }
        tr:active { background: rgba(255, 255, 255, 0.06); }

        td {
          border: none;
          position: relative;
          padding-left: 50%;
          text-align: right;
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 0;
        }
        td:before {
          content: attr(data-label);
          font-weight: 800;
          color: var(--muted);
          font-size: 11px;
          text-transform: uppercase;
        }
        
        /* First child (Date) handling */
        td:first-child {
          text-align: left;
          font-weight: 900;
          color: var(--accent);
          border-bottom: none;
          margin-bottom: 0;
          padding-bottom: 0;
          justify-content: space-between;
          width: 100%;
          padding-left: 0;
        }
        td:first-child:before { display: none; }

        /* Mobile Summary Styling */
        .mobile-summary {
          display: flex;
          gap: 8px;
          align-items: center;
          font-size: 13px;
          color: #fff;
          font-weight: 700;
        }
        .mobile-summary .dim { color: var(--muted); font-weight: 400; }
        .mobile-summary .sum-total { color: #fff; }

        /* Expansion Logic */
        tr:not(.expanded) td:not(:first-child) { display: none; }
        
        tr.expanded td:first-child {
          border-bottom: 1px solid var(--border);
          margin-bottom: 10px;
          padding-bottom: 10px;
        }
        
        tr.expanded .mobile-summary { display: none; }

        tfoot tr { background: var(--accent); color: white; }
        tfoot td { color: white; }
        tfoot td:first-child { color: white; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="header">
        <div class="brand">
          <img src="https://alleycatphoto.net/alley_logo_sm.png" alt="Alley Cat" />
          <div class="brand-text">
            <div class="title">ALLEYCAT SALES BREAKDOWN</div>
            <div class="subtitle">Square vs Card Breakdown</div>
          </div>
        </div>
        <a href="/hawk/admin/index.php" class="back-btn">BACK TO ADMIN</a>
      </div>

      <div class="header" style="margin-bottom: 14px; padding: 12px 20px;">
        <form id="filterForm" class="filters">
          <input type="date" id="start" name="start" />
          <input type="date" id="end" name="end" />
          <button class="btn" type="submit" id="filterBtn">FILTER</button>
          <button class="btn" type="button" id="reloadBtn" style="background: rgba(255,255,255,0.1); border: 1px solid var(--border);">RELOAD</button>
        </form>
      </div>

      <div id="status" class="warn" style="display:none;"></div>

      <!-- Condensed fallback upload card (only appears if remote fetch fails) -->
      <div id="uploadCard" class="warn upload-card">
        <b>Remote CSV blocked.</b> Upload exports instead (runs locally, no Google auth popups).
        <div class="upload-grid">
          <div class="mini">
            <div class="label">Square CSV</div>
            <div class="hint">Select one or many Square exports (merged).</div>
            <input id="squareFiles" type="file" accept=".csv,text/csv" multiple />
          </div>
          <div class="mini">
            <div class="label">Card CSV</div>
            <div class="hint">Select one or many Card exports (merged).</div>
            <input id="cardFiles" type="file" accept=".csv,text/csv" multiple />
          </div>
        </div>
        <div style="margin-top: 10px; display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
          <button class="btn" id="runUploadsBtn" type="button">RUN FROM UPLOADS</button>
          <span style="opacity:0.8; font-size:12px;">Tip: keep headers consistent across files.</span>
        </div>
      </div>

      <div class="summary-grid" id="summaryGrid" style="display:none;">
        <div class="stat-card">
          <div class="stat-label">Total Sales</div>
          <div class="stat-val" id="grandSales">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Orders</div>
          <div class="stat-val" id="grandOrders">0</div>
        </div>
      </div>

      <div id="report"></div>
    </div>

    <script>
      // ====== Config ======
      const SQUARE_URL =
        "SQUARE-TRANSACTIONS.csv";

      const CARD_URL =
        "Card.csv";

      const LOCATIONS = {
        L40Y7W2DPY4XD: "Moonshine Mountain",
        L69EQY1WK4M4A: "Hawks Nest",
        LBV58VND0C84K: "Zip n Slip",
        UNKNOWN: "Other/CPS",
      };

      const LOC_NAME_TO_ID = {
        "Hawksnest": "L69EQY1WK4M4A",
        "ZipnSlip": "LBV58VND0C84K",
        "Moonshine Mt.": "L40Y7W2DPY4XD"
      };

      const DEV_ID_MAP = {
        "2": "L69EQY1WK4M4A",
        "4": "LBV58VND0C84K",
        "3": "L40Y7W2DPY4XD",
      };

      // ====== Utilities ======
      const $ = (id) => document.getElementById(id);

      function isoToday() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function isoMonthStart() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        return `${yyyy}-${mm}-01`;
      }

      function usd(cents) {
        return (cents / 100).toLocaleString(undefined, { style: "currency", currency: "USD" });
      }

      function safeParseDateToISO(dateRaw) {
        const d = new Date(dateRaw);
        if (Number.isNaN(d.getTime())) return null;
        let yyyy = d.getFullYear();
        // Fix 2-digit year: if browser parses "25" as "1925", shift to "2025"
        if (yyyy < 1950) yyyy += 100; 
        
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function isInRange(dateISO, startISO, endISO) {
        return dateISO >= startISO && dateISO <= endISO;
      }

      function clampLocId(raw) {
        if (!raw) return "UNKNOWN";
        return Object.prototype.hasOwnProperty.call(LOCATIONS, raw) ? raw : "UNKNOWN";
      }

      function ensureDay(data, locId, dateISO) {
        if (!data[locId]) data[locId] = {};
        if (!data[locId][dateISO]) data[locId][dateISO] = { square: 0, swiped: 0, manual: 0, orders: 0 };
        return data[locId][dateISO];
      }

      function parseCSV(text) {
        // RFC4180-ish parser: quotes + commas + newlines
        const rows = [];
        let row = [];
        let field = "";
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const c = text[i];

          if (inQuotes) {
            if (c === '"') {
              const next = text[i + 1];
              if (next === '"') {
                field += '"';
                i++;
              } else {
                inQuotes = false;
              }
            } else {
              field += c;
            }
            continue;
          }

          if (c === '"') {
            inQuotes = true;
            continue;
          }

          if (c === ",") {
            row.push(field);
            field = "";
            continue;
          }

          if (c === "\n") {
            row.push(field);
            rows.push(row);
            row = [];
            field = "";
            continue;
          }

          if (c === "\r") continue;

          field += c;
        }

        row.push(field);
        rows.push(row);

        while (rows.length && rows[rows.length - 1].every((v) => v === "")) rows.pop();
        return rows;
      }

      function indexHeaders(headers) {
        const idx = {};
        headers.forEach((h, i) => (idx[String(h).trim()] = i));
        return idx;
      }

      async function fetchTextWithTimeout(url, ms) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), ms);
        try {
          const res = await fetch(url, { method: "GET", signal: ctrl.signal });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.text();
        } finally {
          clearTimeout(t);
        }
      }

      async function fetchCsvRows(url) {
        // Short timeout so we fail fast in embeds that trigger auth/CORS weirdness.
        // Add cache buster
        const urlWithCache = url + "?t=" + Date.now();
        const text = await fetchTextWithTimeout(urlWithCache, 7000);
        return parseCSV(text);
      }

      function sumCardAmountToCents(row, col) {
        const read = (name) => {
          const i = col[name];
          if (i === undefined) return 0;
          const raw = String(row[i] ?? "").trim();
          if (!raw) return 0;
          const num = Number(raw);
          return Number.isFinite(num) ? num : 0;
        };

        const amountDollars =
          read("Amount") +
          read("Tax") +
          read("Surcharges") +
          read("Shipping/Tips") +
          read("Convenience Fee") +
          read("Service Fee");

        return Math.round(amountDollars * 100);
      }

      function inferCardLocId(billCompany, devId) {
        const bc = String(billCompany ?? "").trim();
        const dev = String(devId ?? "").trim();
        let loc = "UNKNOWN";

        if (bc !== "") {
          if (/hawk/i.test(bc) || bc.includes("2")) loc = "L69EQY1WK4M4A";
          else if (/zip/i.test(bc) || bc.includes("3")) loc = "LBV58VND0C84K";
          else if (/moonshine/i.test(bc) || bc.includes("4")) loc = "L40Y7W2DPY4XD";
        }

        if (loc === "UNKNOWN" && dev && DEV_ID_MAP[dev]) loc = DEV_ID_MAP[dev];
        return loc;
      }

      function classifyTranType(tranType) {
        const t = String(tranType ?? "");
        const isSwiped = /swiped|chip|ctls|swipe/i.test(t);
        const isManual = /keyed/i.test(t);
        return { isSwiped, isManual };
      }

      function sortDataDescByDate(data) {
        const locs = Object.keys(data).sort();
        const sorted = { L40Y7W2DPY4XD: {}, L69EQY1WK4M4A: {}, LBV58VND0C84K: {}, UNKNOWN: {} };
        for (const locId of locs) {
          const dates = Object.keys(data[locId] || {}).sort((a, b) => (a < b ? 1 : a > b ? -1 : 0));
          for (const date of dates) sorted[locId][date] = data[locId][date];
        }
        return sorted;
      }

      function computeGrandTotals(data) {
        let total = 0;
        let orders = 0;
        for (const locId of Object.keys(data)) {
          const byDate = data[locId] || {};
          for (const date of Object.keys(byDate)) {
            const s = byDate[date];
            total += (s.square || 0) + (s.swiped || 0) + (s.manual || 0);
            orders += s.orders || 0;
          }
        }
        return { total, orders };
      }

      function computeLocTotals(byDate) {
        let total = 0;
        let orders = 0;
        for (const date of Object.keys(byDate)) {
          const s = byDate[date];
          total += (s.square || 0) + (s.swiped || 0) + (s.manual || 0);
          orders += s.orders || 0;
        }
        return { total, orders };
      }

      async function readFileAsText(file) {
        return await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => reject(new Error("Failed to read file"));
          reader.onload = () => resolve(String(reader.result ?? ""));
          reader.readAsText(file);
        });
      }

      async function loadMergedCsvFromFiles(files) {
        const all = [];
        let headers = null;
        const sorted = [...files].sort((a, b) => a.name.localeCompare(b.name));

        for (const f of sorted) {
          const txt = await readFileAsText(f);
          const rows = parseCSV(txt);
          if (!rows.length) continue;

          if (!headers) {
            headers = rows[0];
            all.push(rows[0]);
          }

          for (let i = 1; i < rows.length; i++) all.push(rows[i]);
        }

        return all;
      }

      // ====== Core loaders ======
      async function buildDataFromRemote(startISO, endISO) {
        const data = { L40Y7W2DPY4XD: {}, L69EQY1WK4M4A: {}, LBV58VND0C84K: {}, UNKNOWN: {} };

        // Square
        const squareRows = await fetchCsvRows(SQUARE_URL);
        if (squareRows.length < 2) throw new Error("Square CSV empty");
        const squareHeaders = squareRows[0];
        const sc = indexHeaders(squareHeaders);
        for (const r of ["Date", "Transaction Status", "Location", "Total Collected"]) {
          if (sc[r] === undefined) throw new Error(`Square missing column: ${r}`);
        }

        for (let i = 1; i < squareRows.length; i++) {
          const row = squareRows[i];
          const dateRaw = row[sc["Date"]] ?? "";
          if (!dateRaw) continue;

          const status = String(row[sc["Transaction Status"]] ?? "").trim();
          if (status !== "Complete") continue;

          const dateISO = dateRaw.trim();
          if (!dateISO || !isInRange(dateISO, startISO, endISO)) continue;

          const locName = String(row[sc["Location"]] ?? "").trim();
          const locId = LOC_NAME_TO_ID[locName] || "UNKNOWN";
          
          const amountStr = String(row[sc["Total Collected"]] ?? "").replace(/[$,]/g, "").trim();
          const amount = Number(amountStr);
          const cents = Number.isFinite(amount) ? Math.round(amount * 100) : 0;

          const day = ensureDay(data, locId, dateISO);
          day.square += cents;
          day.orders += 1;
        }

        // Card
        const cardRows = await fetchCsvRows(CARD_URL);
        if (cardRows.length < 2) throw new Error("Card CSV empty");
        const cardHeaders = cardRows[0];
        const cc = indexHeaders(cardHeaders);
        if (cc["Date"] === undefined) throw new Error("Card missing column: Date");
        if (cc["Response"] === undefined) throw new Error("Card missing column: Response");

        for (let i = 1; i < cardRows.length; i++) {
          const row = cardRows[i];
          const dateRaw = String(row[cc["Date"]] ?? "").trim();
          if (!dateRaw) continue;

          const response = String(row[cc["Response"]] ?? "").trim();
          if (!response.includes("AUTH/TKT")) continue;

          const dateISO = safeParseDateToISO(dateRaw);
          if (!dateISO || !isInRange(dateISO, startISO, endISO)) continue;

          const billCompany = String(row[cc["Bill Company"]] ?? "").trim();
          const devId = String(row[cc["DevID"]] ?? "").trim();
          const locId = inferCardLocId(billCompany, devId);

          const amountCents = sumCardAmountToCents(row, cc);

          const tranType = String(row[cc["Tran Type"]] ?? "").trim();
          const { isSwiped } = classifyTranType(tranType);

          const day = ensureDay(data, locId, dateISO);
          if (isSwiped) day.swiped += amountCents;
          else day.manual += amountCents;
          day.orders += 1;
        }

        return sortDataDescByDate(data);
      }

      async function buildDataFromUploads(startISO, endISO, squareFiles, cardFiles) {
        const data = { L40Y7W2DPY4XD: {}, L69EQY1WK4M4A: {}, LBV58VND0C84K: {}, UNKNOWN: {} };

        const squareRows = await loadMergedCsvFromFiles(squareFiles);
        if (squareRows.length < 2) throw new Error("Square uploads empty");
        const sc = indexHeaders(squareRows[0]);
        for (const r of ["Date", "Transaction Status", "Location", "Total Collected"]) {
          if (sc[r] === undefined) throw new Error(`Square missing column: ${r}`);
        }

        for (let i = 1; i < squareRows.length; i++) {
          const row = squareRows[i];
          const dateRaw = row[sc["Date"]] ?? "";
          if (!dateRaw) continue;

          const status = String(row[sc["Transaction Status"]] ?? "").trim();
          if (status !== "Complete") continue;

          const dateISO = dateRaw.trim();
          if (!dateISO || !isInRange(dateISO, startISO, endISO)) continue;

          const locName = String(row[sc["Location"]] ?? "").trim();
          const locId = LOC_NAME_TO_ID[locName] || "UNKNOWN";
          
          const amountStr = String(row[sc["Total Collected"]] ?? "").replace(/[$,]/g, "").trim();
          const amount = Number(amountStr);
          const cents = Number.isFinite(amount) ? Math.round(amount * 100) : 0;

          const day = ensureDay(data, locId, dateISO);
          day.square += cents;
          day.orders += 1;
        }

        const cardRows = await loadMergedCsvFromFiles(cardFiles);
        if (cardRows.length < 2) throw new Error("Card uploads empty");
        const cc = indexHeaders(cardRows[0]);
        if (cc["Date"] === undefined) throw new Error("Card missing column: Date");
        if (cc["Response"] === undefined) throw new Error("Card missing column: Response");

        for (let i = 1; i < cardRows.length; i++) {
          const row = cardRows[i];
          const dateRaw = String(row[cc["Date"]] ?? "").trim();
          if (!dateRaw) continue;

          const response = String(row[cc["Response"]] ?? "").trim();
          if (!response.includes("AUTH/TKT")) continue;

          const dateISO = safeParseDateToISO(dateRaw);
          if (!dateISO || !isInRange(dateISO, startISO, endISO)) continue;

          const billCompany = String(row[cc["Bill Company"]] ?? "").trim();
          const devId = String(row[cc["DevID"]] ?? "").trim();
          const locId = inferCardLocId(billCompany, devId);

          const amountCents = sumCardAmountToCents(row, cc);

          const tranType = String(row[cc["Tran Type"]] ?? "").trim();
          const { isSwiped } = classifyTranType(tranType);

          const day = ensureDay(data, locId, dateISO);
          if (isSwiped) day.swiped += amountCents;
          else day.manual += amountCents;
          day.orders += 1;
        }

        return sortDataDescByDate(data);
      }

      // ====== Rendering ======
      function setStatus(html, show = true) {
        const el = $("status");
        el.innerHTML = html;
        el.style.display = show ? "block" : "none";
      }

      function showUploadCard(show) {
        $("uploadCard").style.display = show ? "block" : "none";
      }

      function renderReport(data) {
        const report = $("report");
        report.innerHTML = "";

        const hasAny = Object.keys(data).some((locId) => Object.keys(data[locId] || {}).length > 0);
        $("summaryGrid").style.display = hasAny ? "grid" : "none";

        if (!hasAny) {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `<div class="empty">No data found for the selected range.</div>`;
          report.appendChild(card);
          return;
        }

        const grand = computeGrandTotals(data);
        $("grandSales").textContent = usd(grand.total);
        $("grandOrders").textContent = String(grand.orders.toLocaleString());

        const locIds = Object.keys(data).sort();

        for (const locId of locIds) {
          const byDate = data[locId] || {};
          const dates = Object.keys(byDate);
          if (!dates.length) continue;

          const locTotals = computeLocTotals(byDate);

          let tSquare = 0, tSwiped = 0, tManual = 0, tOrders = 0;
          for (const d of dates) {
            const s = byDate[d];
            tSquare += s.square || 0;
            tSwiped += s.swiped || 0;
            tManual += s.manual || 0;
            tOrders += s.orders || 0;
          }

          const card = document.createElement("div");
          card.className = "card";

          const title = LOCATIONS[locId] || locId;

          let body = `
            <div class="card-hd">
              <h2>${escapeHtml(title)}</h2>
              <div class="loc-total">${usd(locTotals.total)} <span style="opacity:0.5; font-size:0.8em;">(${tOrders} orders)</span></div>
            </div>
            <div class="card-bd">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Orders</th>
                    <th>Square</th>
                    <th>Swiped</th>
                    <th>Manual</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
          `;

          for (const date of dates) {
            const s = byDate[date];
            const rowTotal = (s.square || 0) + (s.swiped || 0) + (s.manual || 0);
            body += `
              <tr onclick="this.classList.toggle('expanded')">
                <td data-label="Date">
                  ${escapeHtml(date)}
                  <div class="mobile-summary">
                    <span class="dim">(${(s.orders || 0)})</span>
                    <span class="sum-total">${usd(rowTotal)}</span>
                  </div>
                </td>
                <td data-label="Orders">${(s.orders || 0).toLocaleString()}</td>
                <td data-label="Square" class="col-square">${usd(s.square || 0)}</td>
                <td data-label="Swiped" class="col-swiped">${usd(s.swiped || 0)}</td>
                <td data-label="Manual" class="col-manual">${usd(s.manual || 0)}</td>
                <td data-label="Total" class="col-total">${usd(rowTotal)}</td>
              </tr>
            `;
          }

          body += `
                </tbody>
                <tfoot>
                  <tr onclick="this.classList.toggle('expanded')">
                    <td data-label="Total">
                      TOTAL
                      <div class="mobile-summary">
                        <span class="dim" style="color: rgba(255,255,255,0.8)">(${tOrders})</span>
                        <span class="sum-total">${usd(tSquare + tSwiped + tManual)}</span>
                      </div>
                    </td>
                    <td data-label="Orders">${tOrders.toLocaleString()}</td>
                    <td data-label="Square" class="col-square" style="color: #fff">${usd(tSquare)}</td>
                    <td data-label="Swiped" class="col-swiped" style="color: #fff">${usd(tSwiped)}</td>
                    <td data-label="Manual" class="col-manual" style="color: #fff">${usd(tManual)}</td>
                    <td data-label="Total" class="col-total">${usd(tSquare + tSwiped + tManual)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          `;

          card.innerHTML = body;
          report.appendChild(card);
        }
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // ====== App wiring ======
      function getQueryDates() {
        const u = new URL(window.location.href);
        const start = u.searchParams.get("start") || isoMonthStart();
        const end = u.searchParams.get("end") || isoToday();
        return { start, end };
      }

      function setQueryDates(start, end) {
        const u = new URL(window.location.href);
        u.searchParams.set("start", start);
        u.searchParams.set("end", end);
        history.replaceState({}, "", u.toString());
      }

      let lastData = null;
      let busy = false;

      async function runRemote() {
        const startISO = $("start").value;
        const endISO = $("end").value;

        busy = true;
        $("filterBtn").disabled = true;
        $("reloadBtn").disabled = true;
        setStatus(`<b>Loading…</b> Attempting remote CSV fetch.`, true);
        showUploadCard(false);

        try {
          const data = await buildDataFromRemote(startISO, endISO);
          lastData = data;
          setStatus("", false);
          renderReport(data);
        } catch (e) {
          // Fail => show condensed upload UI
          const msg = e && e.message ? e.message : String(e);
          setStatus(
            `<b>Remote fetch failed.</b> ${escapeHtml(msg)}<br/><span style="opacity:0.85;">Upload will appear below.</span>`,
            true
          );
          showUploadCard(true);
          // Render whatever we had last time (optional)
          if (lastData) renderReport(lastData);
        } finally {
          busy = false;
          $("filterBtn").disabled = false;
          $("reloadBtn").disabled = false;
        }
      }

      async function runUploads() {
        if (busy) return;
        const startISO = $("start").value;
        const endISO = $("end").value;

        const squareFiles = Array.from($("squareFiles").files || []);
        const cardFiles = Array.from($("cardFiles").files || []);

        if (!squareFiles.length || !cardFiles.length) {
          setStatus(`<b>Uploads missing.</b> Please select both Square + Card CSV files.`, true);
          return;
        }

        busy = true;
        $("runUploadsBtn").disabled = true;
        setStatus(`<b>Loading…</b> Parsing uploaded CSV files.`, true);

        try {
          const data = await buildDataFromUploads(startISO, endISO, squareFiles, cardFiles);
          lastData = data;
          setStatus(`<b>Running from uploads.</b> ${squareFiles.length} Square file(s), ${cardFiles.length} Card file(s).`, true);
          renderReport(data);
        } catch (e) {
          const msg = e && e.message ? e.message : String(e);
          setStatus(`<b>Upload parse failed.</b> ${escapeHtml(msg)}`, true);
        } finally {
          busy = false;
          $("runUploadsBtn").disabled = false;
        }
      }

      // Init
      (function init() {
        const { start, end } = getQueryDates();
        $("start").value = start;
        $("end").value = end;

        $("filterForm").addEventListener("submit", (ev) => {
          ev.preventDefault();
          setQueryDates($("start").value, $("end").value);
          runRemote();
        });

        $("reloadBtn").addEventListener("click", () => {
          runRemote();
        });

        $("runUploadsBtn").addEventListener("click", () => {
          setQueryDates($("start").value, $("end").value);
          runUploads();
        });

        // Kick off remote load once.
        runRemote();
      })();
    </script>
  </body>
</html>
